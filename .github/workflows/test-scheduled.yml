name: Test Suite - Scheduled

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
    # Run weekly regression suite on Sunday at 6 AM UTC
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - api
          - ui
          - regression
          - smoke

jobs:
  scheduled-tests:
    name: Scheduled Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Build project
      run: npm run build

    - name: Determine test type
      id: test-type
      run: |
        if [[ "${{ github.event_name }}" == "schedule" && "${{ github.event.schedule }}" == "0 6 * * 0" ]]; then
          echo "type=regression" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "type=${{ github.event.inputs.test_type }}" >> $GITHUB_OUTPUT
        else
          echo "type=all" >> $GITHUB_OUTPUT
        fi

    - name: Run tests
      run: npm run test:${{ steps.test-type.outputs.type }}
      env:
        CI: 'true'
        BASE_URL: ${{ secrets.BASE_URL_PROD }}
        API_BASE_URL: ${{ secrets.API_BASE_URL_PROD }}
        HEADLESS: 'true'
        RETRY_ATTEMPTS: '3'
        REPORT_DIR: './test-results'
      continue-on-error: true
      timeout-minutes: 90

    - name: Generate HTML report
      if: always()
      run: |
        npm run test:report:merge
        npm run test:report:html
      continue-on-error: true

    - name: Upload detailed results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scheduled-test-results-${{ steps.test-type.outputs.type }}
        path: |
          test-results/
          coverage/
          playwright-report/
          html-report/
        retention-days: 90

    - name: Publish test metrics
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-metrics-${{ steps.test-type.outputs.type }}
        path: test-results/metrics.json
        retention-days: 90

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Build project
      run: npm run build

    - name: Run performance tests
      run: npm run test:performance
      env:
        CI: 'true'
        BASE_URL: ${{ secrets.BASE_URL_PROD }}
        API_BASE_URL: ${{ secrets.API_BASE_URL_PROD }}
        HEADLESS: 'true'
      continue-on-error: true

    - name: Upload performance metrics
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-metrics
        path: performance-results/
        retention-days: 90

    - name: Compare with baseline
      if: always()
      run: npm run perf:compare
      continue-on-error: true

  database-tests:
    name: Database Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      mongodb:
        image: mongo:6
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run database tests
      run: npm run test:db
      env:
        POSTGRES_URL: 'postgresql://postgres:postgres@localhost:5432/test_db'
        MONGODB_URI: 'mongodb://localhost:27017/test_db'
      continue-on-error: true

    - name: Upload database test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: database-test-results
        path: test-results/
        retention-days: 30

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [scheduled-tests, performance-tests]
    if: always()
    
    steps:
    - name: Check job statuses
      run: |
        echo "Scheduled Tests: ${{ needs.scheduled-tests.result }}"
        echo "Performance Tests: ${{ needs.performance-tests.result }}"

    - name: Send Slack notification
      if: always()
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "Scheduled QA Test Suite Results",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "Scheduled Tests: ${{ needs.scheduled-tests.result }}\nPerformance Tests: ${{ needs.performance-tests.result }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
      continue-on-error: true

    - name: Create summary
      if: always()
      run: |
        echo "## Scheduled Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Scheduled Tests**: ${{ needs.scheduled-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Performance Tests**: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
